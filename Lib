local SimpleKavo = {}
local TweenService = game:GetService("TweenService") or error("TweenService not available")
local UserInputService = game:GetService("UserInputService") or error("UserInputService not available")
local RunService = game:GetService("RunService") or error("RunService not available")

local Themes = {
    DarkTheme = {
        SchemeColor = Color3.fromRGB(64, 64, 64),
        Background = Color3.fromRGB(0, 0, 0),
        Header = Color3.fromRGB(0, 0, 0),
        TextColor = Color3.fromRGB(255, 255, 255),
        ElementColor = Color3.fromRGB(20, 20, 20)
    },
    HalloweenTheme = {
        SchemeColor = Color3.fromRGB(245, 73, 39),
        Background = Color3.fromRGB(0, 0, 0),
        Header = Color3.fromRGB(0, 0, 0),
        TextColor = Color3.fromRGB(255, 255, 255),
        ElementColor = Color3.fromRGB(20, 20, 20)
    },
    BloodTheme = {
        SchemeColor = Color3.fromRGB(227, 27, 27),
        Background = Color3.fromRGB(10, 10, 10),
        Header = Color3.fromRGB(5, 5, 5),
        TextColor = Color3.fromRGB(255, 255, 255),
        ElementColor = Color3.fromRGB(20, 20, 20)
    },
    DefaultTheme = {
        SchemeColor = Color3.fromRGB(74, 99, 135),
        Background = Color3.fromRGB(36, 37, 43),
        Header = Color3.fromRGB(28, 29, 34),
        TextColor = Color3.fromRGB(255, 255, 255),
        ElementColor = Color3.fromRGB(32, 32, 38)
    }
}

local OPACITY_MAIN = 0.4
local OPACITY_HEADER = 0.35
local OPACITY_ELEMENT = 0.45

local function Tween(object, properties, duration)
    local tweenInfo = TweenInfo.new(duration or 0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(object, tweenInfo, properties)
    tween:Play()
    return tween
end

function SimpleKavo:DraggingEnabled(frame, parent)
    parent = parent or frame
    local dragging = false
    local dragInput, mousePos, framePos
    
    local function startDrag(input)
        dragging = true
        mousePos = input.Position
        framePos = parent.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
    
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            startDrag(input)
        end
    end)
    
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging and
           (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - mousePos
            parent.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset + delta.X, framePos.Y.Scale, framePos.Y.Offset + delta.Y)
        end
    end)
end

function SimpleKavo.CreateLib(title, themeName)
    local currentTheme = Themes[themeName] or Themes.DefaultTheme
    local guiName = "SimpleKavo_Test"
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = guiName
    ScreenGui.ResetOnSpawn = false
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.DisplayOrder = 1000
    
    local success, err = pcall(function()
        ScreenGui.Parent = game.Players.LocalPlayer.PlayerGui
    end)
    if not success then
        warn("Failed to parent ScreenGui to PlayerGui: " .. tostring(err))
        return
    end
    
    local Main = Instance.new("Frame")
    Main.Name = "Main"
    Main.Parent = ScreenGui
    Main.BackgroundColor3 = currentTheme.Background
    Main.BackgroundTransparency = OPACITY_MAIN
    Main.Position = UDim2.new(0.3, 0, 0.3, 0)
    Main.Size = UDim2.new(0, 580, 0, 380)
    Main.ClipsDescendants = true
    Main.ZIndex = 1
    
    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, 8)
    MainCorner.Parent = Main
    
    local Header = Instance.new("Frame")
    Header.Name = "Header"
    Header.Parent = Main
    Header.BackgroundColor3 = currentTheme.Header
    Header.BackgroundTransparency = OPACITY_HEADER
    Header.Size = UDim2.new(1, 0, 0, 28)
    Header.ZIndex = 2
    
    local HeaderCorner = Instance.new("UICorner")
    HeaderCorner.CornerRadius = UDim.new(0, 8)
    HeaderCorner.Parent = Header
    
    local Title = Instance.new("TextLabel")
    Title.Parent = Header
    Title.BackgroundTransparency = 1
    Title.Position = UDim2.new(0.02, 0, 0, 0)
    Title.Size = UDim2.new(0.5, 0, 1, 0)
    Title.Font = Enum.Font.Gotham
    Title.Text = title
    Title.TextColor3 = currentTheme.TextColor
    Title.TextSize = 15
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.ZIndex = 3
    
    local Close = Instance.new("ImageButton")
    Close.Parent = Header
    Close.BackgroundTransparency = 1
    Close.AnchorPoint = Vector2.new(1, 0)
    Close.Position = UDim2.new(1, -8, 0.14, 0)
    Close.Size = UDim2.new(0, 18, 0, 18)
    Close.Image = "rbxassetid://3926305904"
    Close.ImageRectOffset = Vector2.new(284, 4)
    Close.ImageRectSize = Vector2.new(24, 24)
    Close.ImageColor3 = currentTheme.TextColor
    Close.ZIndex = 3
    
    Close.MouseButton1Click:Connect(function()
        Tween(Main, {Size = UDim2.new(0, 0, 0, 0)})
        task.wait(0.3)
        ScreenGui:Destroy()
    end)
    
    local Minimized = false
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if input.KeyCode == Enum.KeyCode.F1 then
            Minimized = not Minimized
            if Minimized then
                Tween(Main, {Size = UDim2.new(0, 0, 0, 0)})
            else
                Tween(Main, {Size = UDim2.new(0, 580, 0, 380)})
            end
        end
    end)
    
    SimpleKavo:DraggingEnabled(Header, Main)
    
    local TabBar = Instance.new("Frame")
    TabBar.Name = "TabBar"
    TabBar.Parent = Main
    TabBar.BackgroundTransparency = 1
    TabBar.Position = UDim2.new(0, 0, 0, 28)
    TabBar.Size = UDim2.new(1, 0, 0, 36)
    TabBar.ZIndex = 2
    
    local TabList = Instance.new("UIListLayout")
    TabList.Parent = TabBar
    TabList.FillDirection = Enum.FillDirection.Horizontal
    TabList.SortOrder = Enum.SortOrder.LayoutOrder
    TabList.Padding = UDim.new(0, 6)
    TabList.HorizontalAlignment = Enum.HorizontalAlignment.Left
    TabList.VerticalAlignment = Enum.VerticalAlignment.Center
    
    local TabPadding = Instance.new("UIPadding")
    TabPadding.Parent = TabBar
    TabPadding.PaddingLeft = UDim.new(0, 14)
    
    local Content = Instance.new("Frame")
    Content.Name = "Content"
    Content.Parent = Main
    Content.BackgroundTransparency = 1
    Content.Position = UDim2.new(0, 0, 0, 64)
    Content.Size = UDim2.new(1, 0, 1, -64)
    Content.ZIndex = 2
    
    local function updateContentZIndex(frame, zIndex)
        for _, child in pairs(frame:GetChildren()) do
            if child:IsA("Frame") or child:IsA("TextButton") or child:IsA("TextLabel") or child:IsA("ScrollingFrame") then
                child.ZIndex = zIndex
                updateContentZIndex(child, zIndex + 1)
            end
        end
    end
    updateContentZIndex(Content, 3)
    
    local tabsOrder = {}
    local currentTab = nil
    
    function SimpleKavo:AddTab(name)
        local TabButton = Instance.new("TextButton")
        TabButton.Name = name
        TabButton.Parent = TabBar
        TabButton.BackgroundColor3 = currentTheme.ElementColor
        TabButton.BackgroundTransparency = OPACITY_ELEMENT + 0.08
        TabButton.Size = UDim2.new(0, 0, 0.78, 0)
        TabButton.Font = Enum.Font.GothamSemibold
        TabButton.Text = name
        TabButton.TextColor3 = currentTheme.TextColor
        TabButton.TextSize = 14
        TabButton.AutoButtonColor = false
        TabButton.ZIndex = 3
        TabButton.AutomaticSize = Enum.AutomaticSize.X
        
        local TabCorner = Instance.new("UICorner")
        TabCorner.CornerRadius = UDim.new(0, 6)
        TabCorner.Parent = TabButton
        
        local TabContent = Instance.new("ScrollingFrame")
        TabContent.Name = name.."_Content"
        TabContent.Parent = Content
        TabContent.BackgroundTransparency = 1
        TabContent.Size = UDim2.new(1, 0, 1, 0)
        TabContent.Visible = false
        TabContent.ScrollBarThickness = 4
        TabContent.ScrollBarImageColor3 = currentTheme.SchemeColor
        TabContent.CanvasSize = UDim2.new(0, 0, 0, 0)
        TabContent.AutomaticCanvasSize = Enum.AutomaticSize.Y
        TabContent.ScrollingDirection = Enum.ScrollingDirection.Y
        TabContent.ZIndex = 3
        
        local TabContentList = Instance.new("UIListLayout")
        TabContentList.Parent = TabContent
        TabContentList.Padding = UDim.new(0, 12)
        TabContentList.HorizontalAlignment = Enum.HorizontalAlignment.Center
        
        table.insert(tabsOrder, {
            button = TabButton,
            content = TabContent
        })
        
        TabButton.MouseButton1Click:Connect(function()
            for _, tab in ipairs(tabsOrder) do
                tab.content.Visible = false
                Tween(tab.button, {BackgroundTransparency = OPACITY_ELEMENT + 0.08}, 0.18)
            end
            TabContent.Visible = true
            Tween(TabButton, {BackgroundTransparency = 0.12}, 0.18)
            currentTab = TabButton
        end)
        
        if #tabsOrder == 1 then
            TabContent.Visible = true
            Tween(TabButton, {BackgroundTransparency = 0.12}, 0.18)
            currentTab = TabButton
        end
        
        local TabFunctions = {}
        
        function TabFunctions:NewSection(name)
            local SectionFrame = Instance.new("Frame")
            SectionFrame.Name = name.."_Section"
            SectionFrame.Parent = TabContent
            SectionFrame.BackgroundTransparency = 1
            SectionFrame.Size = UDim2.new(0.92, 0, 0, 0)
            SectionFrame.AutomaticSize = Enum.AutomaticSize.Y
            SectionFrame.ZIndex = 4
            
            local SectionLabel = Instance.new("TextLabel")
            SectionLabel.Name = "Label"
            SectionLabel.Parent = SectionFrame
            SectionLabel.BackgroundTransparency = 1
            SectionLabel.Size = UDim2.new(1, 0, 0, 28)
            SectionLabel.Font = Enum.Font.GothamSemibold
            SectionLabel.Text = name
            SectionLabel.TextColor3 = currentTheme.TextColor
            SectionLabel.TextSize = 15
            SectionLabel.TextXAlignment = Enum.TextXAlignment.Left
            SectionLabel.ZIndex = 6
            
            local SectionLine = Instance.new("Frame")
            SectionLine.Name = "Line"
            SectionLine.Parent = SectionFrame
            SectionLine.BackgroundColor3 = currentTheme.SchemeColor
            SectionLine.BorderSizePixel = 0
            SectionLine.Position = UDim2.new(0, 0, 0, 26)
            SectionLine.Size = UDim2.new(1, 0, 0, 1)
            SectionLine.ZIndex = 6
            
            local SectionContent = Instance.new("Frame")
            SectionContent.Name = "Content"
            SectionContent.Parent = SectionFrame
            SectionContent.BackgroundTransparency = 1
            SectionContent.Position = UDim2.new(0, 0, 0, 34)
            SectionContent.Size = UDim2.new(1, 0, 0, 0)
            SectionContent.AutomaticSize = Enum.AutomaticSize.Y
            SectionContent.ZIndex = 5
            
            local SectionList = Instance.new("UIListLayout")
            SectionList.Parent = SectionContent
            SectionList.Padding = UDim.new(0, 8)
            SectionList.SortOrder = Enum.SortOrder.LayoutOrder
            
            SectionList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                SectionFrame.Size = UDim2.new(0.92, 0, 0, SectionList.AbsoluteContentSize.Y + 34)
            end)
            
            local SectionFunctions = {}
            
            function SectionFunctions:NewButton(name, description, callback)
                local Button = Instance.new("TextButton")
                Button.Name = name
                Button.BackgroundColor3 = currentTheme.ElementColor
                Button.BackgroundTransparency = OPACITY_ELEMENT
                Button.Size = UDim2.new(1, 0, 0, 38)
                Button.Font = Enum.Font.Gotham
                Button.Text = name
                Button.TextColor3 = currentTheme.TextColor
                Button.TextSize = 14
                Button.AutoButtonColor = false
                Button.ZIndex = 6
                
                if description then
                    local DescLabel = Instance.new("TextLabel")
                    DescLabel.Name = "Description"
                    DescLabel.Parent = Button
                    DescLabel.BackgroundTransparency = 1
                    DescLabel.Position = UDim2.new(0, 12, 1, -17)
                    DescLabel.Size = UDim2.new(1, -24, 0, 13)
                    DescLabel.Font = Enum.Font.Gotham
                    DescLabel.Text = description
                    DescLabel.TextColor3 = currentTheme.TextColor
                    DescLabel.TextSize = 10
                    DescLabel.TextXAlignment = Enum.TextXAlignment.Left
                    DescLabel.ZIndex = 7
                end
                
                local ButtonCorner = Instance.new("UICorner")
                ButtonCorner.CornerRadius = UDim.new(0, 6)
                ButtonCorner.Parent = Button
                
                Button.MouseEnter:Connect(function()
                    Tween(Button, {
                        BackgroundColor3 = Color3.fromRGB(
                            math.floor(currentTheme.ElementColor.R * 255 + 38),
                            math.floor(currentTheme.ElementColor.G * 255 + 38),
                            math.floor(currentTheme.ElementColor.B * 255 + 38)
                        ),
                        BackgroundTransparency = OPACITY_ELEMENT - 0.2
                    }, 0.14)
                end)
                
                Button.MouseLeave:Connect(function()
                    Tween(Button, {
                        BackgroundColor3 = currentTheme.ElementColor,
                        BackgroundTransparency = OPACITY_ELEMENT
                    }, 0.14)
                end)
                
                Button.MouseButton1Click:Connect(function()
                    if callback then callback() end
                end)
                
                Button.Parent = SectionContent
                return Button
            end
            
            function SectionFunctions:NewToggle(name, description, callback)
                local ToggleFrame = Instance.new("Frame")
                ToggleFrame.Name = name .. "_Toggle"
                ToggleFrame.BackgroundTransparency = 1
                ToggleFrame.Size = UDim2.new(1, 0, 0, description and 52 or 38)
                ToggleFrame.ZIndex = 6
                
                local ToggleButton = Instance.new("TextButton")
                ToggleButton.Name = "Button"
                ToggleButton.Parent = ToggleFrame
                ToggleButton.BackgroundColor3 = currentTheme.ElementColor
                ToggleButton.BackgroundTransparency = OPACITY_ELEMENT
                ToggleButton.Size = UDim2.new(0, 34, 0, 34)
                ToggleButton.Position = UDim2.new(1, -42, 0, 2)
                ToggleButton.Font = Enum.Font.Gotham
                ToggleButton.Text = ""
                ToggleButton.TextColor3 = currentTheme.TextColor
                ToggleButton.TextSize = 14
                ToggleButton.AutoButtonColor = false
                ToggleButton.ZIndex = 7
                
                local ToggleCorner = Instance.new("UICorner")
                ToggleCorner.CornerRadius = UDim.new(0, 6)
                ToggleCorner.Parent = ToggleButton
                
                local ToggleText = Instance.new("TextLabel")
                ToggleText.Name = "Text"
                ToggleText.Parent = ToggleFrame
                ToggleText.BackgroundTransparency = 1
                ToggleText.Position = UDim2.new(0, 12, 0, 0)
                ToggleText.Size = UDim2.new(0.7, 0, 0, 38)
                ToggleText.Font = Enum.Font.Gotham
                ToggleText.Text = name
                ToggleText.TextColor3 = currentTheme.TextColor
                ToggleText.TextSize = 14
                ToggleText.TextXAlignment = Enum.TextXAlignment.Left
                ToggleText.ZIndex = 7
                
                if description then
                    local DescLabel = Instance.new("TextLabel")
                    DescLabel.Name = "Description"
                    DescLabel.Parent = ToggleFrame
                    DescLabel.BackgroundTransparency = 1
                    DescLabel.Position = UDim2.new(0, 12, 0, 26)
                    DescLabel.Size = UDim2.new(0.7, 0, 0, 16)
                    DescLabel.Font = Enum.Font.Gotham
                    DescLabel.Text = description
                    DescLabel.TextColor3 = currentTheme.TextColor
                    DescLabel.TextSize = 10
                    DescLabel.TextXAlignment = Enum.TextXAlignment.Left
                    DescLabel.ZIndex = 7
                end
                
                local State = false
                
                local function UpdateToggle()
                    if State then
                        Tween(ToggleButton, {BackgroundColor3 = currentTheme.SchemeColor, BackgroundTransparency = 0.28}, 0.2)
                    else
                        Tween(ToggleButton, {BackgroundColor3 = currentTheme.ElementColor, BackgroundTransparency = OPACITY_ELEMENT}, 0.2)
                    end
                end
                
                UpdateToggle()
                
                ToggleButton.MouseButton1Click:Connect(function()
                    State = not State
                    UpdateToggle()
                    if callback then callback(State) end
                end)
                
                ToggleFrame.Parent = SectionContent
                
                local ToggleObject = {}
                
                function ToggleObject:Set(newState, silent)
                    if State == newState then return end
                    State = newState
                    UpdateToggle()
                    if callback and not silent then
                        callback(State)
                    end
                end
                
                function ToggleObject:Get()
                    return State
                end
                
                ToggleObject.Frame = ToggleFrame
                
                return ToggleObject
            end
            
            function SectionFunctions:NewDropdown(name, options, defaultOption, callback)
                local isOpen = false
                local selectedOption = defaultOption or (options and options[1]) or ""
                local DropdownFrame = Instance.new("Frame")
                DropdownFrame.Name = name.."_Dropdown"
                DropdownFrame.BackgroundTransparency = 1
                DropdownFrame.Size = UDim2.new(1, 0, 0, 38)
                DropdownFrame.ClipsDescendants = true
                DropdownFrame.ZIndex = 6
                
                local MainButton = Instance.new("TextButton")
                MainButton.Name = "MainButton"
                MainButton.Parent = DropdownFrame
                MainButton.BackgroundColor3 = currentTheme.ElementColor
                MainButton.BackgroundTransparency = OPACITY_ELEMENT
                MainButton.Size = UDim2.new(1, 0, 0, 38)
                MainButton.Font = Enum.Font.Gotham
                MainButton.Text = name..": "..tostring(selectedOption)
                MainButton.TextColor3 = currentTheme.TextColor
                MainButton.TextSize = 14
                MainButton.TextXAlignment = Enum.TextXAlignment.Left
                MainButton.AutoButtonColor = false
                MainButton.ZIndex = 7
                
                local ButtonCorner = Instance.new("UICorner")
                ButtonCorner.CornerRadius = UDim.new(0, 6)
                ButtonCorner.Parent = MainButton
                
                local Arrow = Instance.new("TextLabel")
                Arrow.Name = "Arrow"
                Arrow.Parent = MainButton
                Arrow.BackgroundTransparency = 1
                Arrow.Size = UDim2.new(0, 22, 0, 22)
                Arrow.Position = UDim2.new(1, -28, 0, 8)
                Arrow.Text = "▼"
                Arrow.TextColor3 = currentTheme.TextColor
                Arrow.Font = Enum.Font.Gotham
                Arrow.TextSize = 14
                Arrow.ZIndex = 7
                
                local OptionsFrame = Instance.new("Frame")
                OptionsFrame.Name = "OptionsFrame"
                OptionsFrame.Parent = DropdownFrame
                OptionsFrame.BackgroundColor3 = currentTheme.ElementColor
                OptionsFrame.BackgroundTransparency = OPACITY_ELEMENT
                OptionsFrame.Position = UDim2.new(0, 0, 0, 44)
                OptionsFrame.Size = UDim2.new(1, 0, 0, 0)
                OptionsFrame.Visible = false
                OptionsFrame.ClipsDescendants = true
                OptionsFrame.ZIndex = 8
                
                local OptionsCorner = Instance.new("UICorner")
                OptionsCorner.CornerRadius = UDim.new(0, 6)
                OptionsCorner.Parent = OptionsFrame
                
                local OptionsList = Instance.new("UIListLayout")
                OptionsList.Parent = OptionsFrame
                OptionsList.Padding = UDim.new(0, 6)
                OptionsList.HorizontalAlignment = Enum.HorizontalAlignment.Left
                
                local function createOptions()
                    for _, child in ipairs(OptionsFrame:GetChildren()) do
                        if child:IsA("TextButton") then child:Destroy() end
                    end
                    if not options or #options == 0 then
                        local NoOptions = Instance.new("TextLabel")
                        NoOptions.Parent = OptionsFrame
                        NoOptions.BackgroundTransparency = 1
                        NoOptions.Size = UDim2.new(1, 0, 0, 32)
                        NoOptions.Text = ""
                        NoOptions.TextColor3 = currentTheme.TextColor
                        NoOptions.Font = Enum.Font.Gotham
                        NoOptions.TextSize = 12
                        NoOptions.ZIndex = 9
                        return
                    end
                    for _, option in ipairs(options) do
                        local OptionButton = Instance.new("TextButton")
                        OptionButton.Name = tostring(option)
                        OptionButton.Parent = OptionsFrame
                        OptionButton.BackgroundColor3 = currentTheme.ElementColor
                        OptionButton.BackgroundTransparency = OPACITY_ELEMENT
                        OptionButton.Size = UDim2.new(1, -12, 0, 32)
                        OptionButton.Position = UDim2.new(0, 6, 0, 0)
                        OptionButton.Font = Enum.Font.Gotham
                        OptionButton.Text = tostring(option)
                        OptionButton.TextColor3 = currentTheme.TextColor
                        OptionButton.TextSize = 14
                        OptionButton.AutoButtonColor = false
                        OptionButton.ZIndex = 9
                        
                        local OptionCorner = Instance.new("UICorner")
                        OptionCorner.CornerRadius = UDim.new(0, 6)
                        OptionCorner.Parent = OptionButton
                        
                        OptionButton.MouseButton1Click:Connect(function()
                            selectedOption = option
                            MainButton.Text = name..": "..tostring(selectedOption)
                            isOpen = false
                            OptionsFrame.Visible = false
                            Tween(OptionsFrame, {Size = UDim2.new(1, 0, 0, 0)}, 0.2)
                            Tween(DropdownFrame, {Size = UDim2.new(1, 0, 0, 38)}, 0.2)
                            Tween(Arrow, {Rotation = 0}, 0.2)
                            if callback then callback(option) end
                        end)
                        
                        OptionButton.MouseEnter:Connect(function()
                            Tween(OptionButton, {
                                BackgroundColor3 = Color3.fromRGB(
                                    math.floor(currentTheme.ElementColor.R * 255 + 35),
                                    math.floor(currentTheme.ElementColor.G * 255 + 35),
                                    math.floor(currentTheme.ElementColor.B * 255 + 35)
                                ),
                                BackgroundTransparency = OPACITY_ELEMENT - 0.18
                            }, 0.12)
                        end)
                        
                        OptionButton.MouseLeave:Connect(function()
                            Tween(OptionButton, {
                                BackgroundColor3 = currentTheme.ElementColor,
                                BackgroundTransparency = OPACITY_ELEMENT
                            }, 0.12)
                        end)
                    end
                end
                
                createOptions()
                
                local function toggleDropdown()
                    isOpen = not isOpen
                    Tween(Arrow, {Rotation = isOpen and 180 or 0}, 0.2)
                    if isOpen then
                        local optionCount = #options > 0 and #options or 1
                        local totalHeight = optionCount * 38 + (optionCount-1)*6
                        OptionsFrame.Visible = true
                        Tween(DropdownFrame, {Size = UDim2.new(1, 0, 0, 38 + totalHeight + 6)}, 0.2)
                        Tween(OptionsFrame, {Size = UDim2.new(1, 0, 0, totalHeight)}, 0.2)
                    else
                        Tween(DropdownFrame, {Size = UDim2.new(1, 0, 0, 38)}, 0.2)
                        Tween(OptionsFrame, {Size = UDim2.new(1, 0, 0, 0)}, 0.2)
                        task.wait(0.2)
                        OptionsFrame.Visible = false
                    end
                end
                
                MainButton.MouseButton1Click:Connect(toggleDropdown)
                
                local dropdownConnection = UserInputService.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 and isOpen then
                        local pos = input.Position
                        local framePos = DropdownFrame.AbsolutePosition
                        local frameSize = DropdownFrame.AbsoluteSize
                        if not (pos.X >= framePos.X and pos.X <= framePos.X + frameSize.X and
                               pos.Y >= framePos.Y and pos.Y <= framePos.Y + frameSize.Y) then
                            toggleDropdown()
                        end
                    end
                end)
                
                DropdownFrame.Destroying:Connect(function()
                    dropdownConnection:Disconnect()
                end)
                
                local dropdownMethods = {}
                
                function dropdownMethods:Set(newOption)
                    if table.find(options, newOption) then
                        selectedOption = newOption
                        MainButton.Text = name..": "..tostring(selectedOption)
                    end
                end
                
                function dropdownMethods:Get()
                    return selectedOption
                end
                
                function dropdownMethods:Update(newOptions, newDefault)
                    options = newOptions or options
                    selectedOption = newDefault or selectedOption or (options and options[1]) or "Selecione"
                    MainButton.Text = name..": "..tostring(selectedOption)
                    createOptions()
                    if isOpen then toggleDropdown() end
                end
                
                DropdownFrame.Parent = SectionContent
                return dropdownMethods
            end
            
            function SectionFunctions:NewToggleDropdown(name, options, defaultSelected, callback)
                local isOpen = false
                local selected = {}
                if defaultSelected and type(defaultSelected) == "table" then
                    for _, opt in ipairs(defaultSelected) do
                        selected[opt] = true
                    end
                end
                
                local DropdownFrame = Instance.new("Frame")
                DropdownFrame.Name = name.."_ToggleDropdown"
                DropdownFrame.BackgroundTransparency = 1
                DropdownFrame.Size = UDim2.new(1, 0, 0, 38)
                DropdownFrame.ClipsDescendants = true
                DropdownFrame.ZIndex = 6
                
                local MainButton = Instance.new("TextButton")
                MainButton.Name = "MainButton"
                MainButton.Parent = DropdownFrame
                MainButton.BackgroundColor3 = currentTheme.ElementColor
                MainButton.BackgroundTransparency = OPACITY_ELEMENT
                MainButton.Size = UDim2.new(1, 0, 0, 38)
                MainButton.Font = Enum.Font.Gotham
                MainButton.Text = name
                MainButton.TextColor3 = currentTheme.TextColor
                MainButton.TextSize = 14
                MainButton.TextXAlignment = Enum.TextXAlignment.Left
                MainButton.AutoButtonColor = false
                MainButton.ZIndex = 7
                
                local ButtonCorner = Instance.new("UICorner")
                ButtonCorner.CornerRadius = UDim.new(0, 6)
                ButtonCorner.Parent = MainButton
                
                local Arrow = Instance.new("TextLabel")
                Arrow.Name = "Arrow"
                Arrow.Parent = MainButton
                Arrow.BackgroundTransparency = 1
                Arrow.Size = UDim2.new(0, 22, 0, 22)
                Arrow.Position = UDim2.new(1, -28, 0, 8)
                Arrow.Text = "▼"
                Arrow.TextColor3 = currentTheme.TextColor
                Arrow.Font = Enum.Font.Gotham
                Arrow.TextSize = 14
                Arrow.ZIndex = 7
                
                local OptionsFrame = Instance.new("Frame")
                OptionsFrame.Name = "OptionsFrame"
                OptionsFrame.Parent = DropdownFrame
                OptionsFrame.BackgroundColor3 = currentTheme.ElementColor
                OptionsFrame.BackgroundTransparency = OPACITY_ELEMENT
                OptionsFrame.Position = UDim2.new(0, 0, 0, 44)
                OptionsFrame.Size = UDim2.new(1, 0, 0, 0)
                OptionsFrame.Visible = false
                OptionsFrame.ClipsDescendants = true
                OptionsFrame.ZIndex = 8
                
                local OptionsCorner = Instance.new("UICorner")
                OptionsCorner.CornerRadius = UDim.new(0, 6)
                OptionsCorner.Parent = OptionsFrame
                
                local OptionsList = Instance.new("UIListLayout")
                OptionsList.Parent = OptionsFrame
                OptionsList.Padding = UDim.new(0, 4)
                OptionsList.HorizontalAlignment = Enum.HorizontalAlignment.Center
                
                local function createOptions()
                    for _, child in ipairs(OptionsFrame:GetChildren()) do
                        if child:IsA("TextButton") then child:Destroy() end
                    end
                    for _, option in ipairs(options) do
                        local OptionButton = Instance.new("TextButton")
                        OptionButton.Name = tostring(option)
                        OptionButton.Parent = OptionsFrame
                        OptionButton.BackgroundColor3 = currentTheme.ElementColor
                        OptionButton.BackgroundTransparency = OPACITY_ELEMENT
                        OptionButton.Size = UDim2.new(1, -16, 0, 32)
                        OptionButton.Font = Enum.Font.Gotham
                        OptionButton.Text = " " .. tostring(option)
                        OptionButton.TextColor3 = currentTheme.TextColor
                        OptionButton.TextSize = 14
                        OptionButton.AutoButtonColor = false
                        OptionButton.ZIndex = 9
                        OptionButton.TextXAlignment = Enum.TextXAlignment.Left
                        
                        local OptionCorner = Instance.new("UICorner")
                        OptionCorner.CornerRadius = UDim.new(0, 6)
                        OptionCorner.Parent = OptionButton
                        
                        local CheckMark = Instance.new("TextLabel")
                        CheckMark.Name = "CheckMark"
                        CheckMark.Parent = OptionButton
                        CheckMark.BackgroundTransparency = 1
                        CheckMark.Size = UDim2.new(0, 20, 0, 20)
                        CheckMark.Position = UDim2.new(1, -26, 0.5, -10)
                        CheckMark.Font = Enum.Font.GothamBold
                        CheckMark.Text = selected[option] and "✓" or ""
                        CheckMark.TextColor3 = Color3.fromRGB(255,255,255)
                        CheckMark.TextSize = 16
                        CheckMark.ZIndex = 10
                        
                        if selected[option] then
                            OptionButton.BackgroundColor3 = currentTheme.SchemeColor
                            OptionButton.BackgroundTransparency = 0.45
                        end
                        
                        OptionButton.MouseButton1Click:Connect(function()
                            selected[option] = not selected[option]
                            if selected[option] then
                                Tween(OptionButton, {
                                    BackgroundColor3 = currentTheme.SchemeColor,
                                    BackgroundTransparency = 0.45
                                }, 0.15)
                                CheckMark.Text = "✓"
                            else
                                Tween(OptionButton, {
                                    BackgroundColor3 = currentTheme.ElementColor,
                                    BackgroundTransparency = OPACITY_ELEMENT
                                }, 0.15)
                                CheckMark.Text = ""
                            end
                            if callback then callback(option, selected[option]) end
                        end)
                        
                        OptionButton.MouseEnter:Connect(function()
                            if not selected[option] then
                                Tween(OptionButton, {BackgroundTransparency = OPACITY_ELEMENT - 0.25}, 0.12)
                            end
                        end)
                        
                        OptionButton.MouseLeave:Connect(function()
                            if not selected[option] then
                                Tween(OptionButton, {BackgroundTransparency = OPACITY_ELEMENT}, 0.12)
                            end
                        end)
                    end
                end
                
                createOptions()
                
                local function toggleDropdown()
                    isOpen = not isOpen
                    Tween(Arrow, {Rotation = isOpen and 180 or 0}, 0.2)
                    if isOpen then
                        local count = math.max(#options, 1)
                        local height = count * 36 + (count - 1) * 4 + 12
                        OptionsFrame.Visible = true
                        Tween(DropdownFrame, {Size = UDim2.new(1, 0, 0, 38 + height)}, 0.2)
                        Tween(OptionsFrame, {Size = UDim2.new(1, 0, 0, height)}, 0.2)
                    else
                        Tween(DropdownFrame, {Size = UDim2.new(1, 0, 0, 38)}, 0.2)
                        Tween(OptionsFrame, {Size = UDim2.new(1, 0, 0, 0)}, 0.2)
                        task.wait(0.25)
                        OptionsFrame.Visible = false
                    end
                end
                
                MainButton.MouseButton1Click:Connect(toggleDropdown)
                
                local closeConnection = UserInputService.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 and isOpen then
                        local pos = input.Position
                        local fpos = DropdownFrame.AbsolutePosition
                        local fsize = DropdownFrame.AbsoluteSize
                        if not (pos.X >= fpos.X and pos.X <= fpos.X + fsize.X and
                                pos.Y >= fpos.Y and pos.Y <= fpos.Y + fsize.Y) then
                            toggleDropdown()
                        end
                    end
                end)
                
                DropdownFrame.Destroying:Connect(function()
                    closeConnection:Disconnect()
                end)
                
                local methods = {}
                
                function methods:GetSelected()
                    local list = {}
                    for k, v in pairs(selected) do
                        if v then table.insert(list, k) end
                    end
                    return list
                end
                
                function methods:SetSelected(tbl)
                    selected = {}
                    if type(tbl) == "table" then
                        for _, v in ipairs(tbl) do
                            selected[v] = true
                        end
                    end
                    createOptions()
                end
                
                DropdownFrame.Parent = SectionContent
                return methods
            end
            
            function SectionFunctions:NewTextBox(name, placeholder, callback)
                local TextBoxFrame = Instance.new("Frame")
                TextBoxFrame.Name = name .. "_TextBox"
                TextBoxFrame.BackgroundTransparency = 1
                TextBoxFrame.Size = UDim2.new(1, 0, 0, 38)
                TextBoxFrame.ZIndex = 6
                
                local TextBox = Instance.new("TextBox")
                TextBox.Name = "Input"
                TextBox.Parent = TextBoxFrame
                TextBox.BackgroundColor3 = currentTheme.ElementColor
                TextBox.BackgroundTransparency = OPACITY_ELEMENT
                TextBox.Size = UDim2.new(1, 0, 0, 32)
                TextBox.Position = UDim2.new(0, 0, 0, 3)
                TextBox.Font = Enum.Font.Gotham
                TextBox.PlaceholderText = placeholder or "Digite aqui..."
                TextBox.Text = ""
                TextBox.TextColor3 = currentTheme.TextColor
                TextBox.TextSize = 14
                TextBox.TextXAlignment = Enum.TextXAlignment.Left
                TextBox.TextTruncate = Enum.TextTruncate.AtEnd
                TextBox.ClearTextOnFocus = false
                TextBox.ZIndex = 7
                
                local TextBoxCorner = Instance.new("UICorner")
                TextBoxCorner.CornerRadius = UDim.new(0, 6)
                TextBoxCorner.Parent = TextBox
                
                local TextBoxLabel = Instance.new("TextLabel")
                TextBoxLabel.Name = "Label"
                TextBoxLabel.Parent = TextBoxFrame
                TextBoxLabel.BackgroundTransparency = 1
                TextBoxLabel.Size = UDim2.new(1, 0, 0, 20)
                TextBoxLabel.Position = UDim2.new(0, 6, 0, 0)
                TextBoxLabel.Font = Enum.Font.Gotham
                TextBoxLabel.Text = name
                TextBoxLabel.TextColor3 = currentTheme.TextColor
                TextBoxLabel.TextSize = 12
                TextBoxLabel.TextXAlignment = Enum.TextXAlignment.Left
                TextBoxLabel.ZIndex = 7
                
                TextBox.MouseEnter:Connect(function()
                    Tween(TextBox, {
                        BackgroundColor3 = Color3.fromRGB(
                            math.floor(currentTheme.ElementColor.R * 255 + 35),
                            math.floor(currentTheme.ElementColor.G * 255 + 35),
                            math.floor(currentTheme.ElementColor.B * 255 + 35)
                        ),
                        BackgroundTransparency = OPACITY_ELEMENT - 0.18
                    }, 0.12)
                end)
                
                TextBox.MouseLeave:Connect(function()
                    Tween(TextBox, {
                        BackgroundColor3 = currentTheme.ElementColor,
                        BackgroundTransparency = OPACITY_ELEMENT
                    }, 0.12)
                end)
                
                TextBox.FocusLost:Connect(function(enterPressed)
                    if enterPressed and callback then
                        callback(TextBox.Text)
                    end
                end)
                
                TextBoxFrame.Parent = SectionContent
                
                local methods = {}
                
                function methods:Set(newText)
                    TextBox.Text = tostring(newText)
                    if callback then callback(TextBox.Text) end
                end
                
                function methods:Get()
                    return TextBox.Text
                end
                
                return methods
            end
            
            function SectionFunctions:NewSlider(name, min, max, default, callback)
                local SliderFrame = Instance.new("Frame")
                SliderFrame.Name = name.."_Slider"
                SliderFrame.BackgroundTransparency = 1
                SliderFrame.Size = UDim2.new(1, 0, 0, 54)
                SliderFrame.ZIndex = 6
                
                local SliderText = Instance.new("TextLabel")
                SliderText.Name = "Text"
                SliderText.Parent = SliderFrame
                SliderText.BackgroundTransparency = 1
                SliderText.Size = UDim2.new(1, 0, 0.38, 0)
                SliderText.Font = Enum.Font.Gotham
                SliderText.Text = name..": "..default
                SliderText.TextColor3 = currentTheme.TextColor
                SliderText.TextSize = 14
                SliderText.TextXAlignment = Enum.TextXAlignment.Left
                SliderText.ZIndex = 7
                
                local SliderBar = Instance.new("Frame")
                SliderBar.Name = "Bar"
                SliderBar.Parent = SliderFrame
                SliderBar.BackgroundColor3 = currentTheme.ElementColor
                SliderBar.BackgroundTransparency = OPACITY_ELEMENT
                SliderBar.Size = UDim2.new(1, 0, 0.22, 0)
                SliderBar.Position = UDim2.new(0, 0, 0.58, 0)
                SliderBar.ZIndex = 7
                
                local SliderCorner = Instance.new("UICorner")
                SliderCorner.Parent = SliderBar
                
                local SliderFill = Instance.new("Frame")
                SliderFill.Name = "Fill"
                SliderFill.Parent = SliderBar
                SliderFill.BackgroundColor3 = currentTheme.SchemeColor
                SliderFill.BackgroundTransparency = 0.28
                SliderFill.Size = UDim2.new((default - min)/(max - min), 0, 1, 0)
                SliderFill.ZIndex = 8
                
                local SliderFillCorner = Instance.new("UICorner")
                SliderFillCorner.Parent = SliderFill
                
                local dragging = false
                
                local function UpdateSlider(value)
                    local percent = math.clamp((value - min)/(max - min), 0, 1)
                    Tween(SliderFill, {Size = UDim2.new(percent, 0, 1, 0)}, 0.1)
                    SliderText.Text = name..": "..math.floor(value)
                    if callback then callback(value) end
                end
                
                SliderBar.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                        dragging = true
                    end
                end)
                
                SliderBar.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                        dragging = false
                    end
                end)
                
                UserInputService.InputChanged:Connect(function(input)
                    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                        local pos = input.Position.X - SliderBar.AbsolutePosition.X
                        local percent = math.clamp(pos/SliderBar.AbsoluteSize.X, 0, 1)
                        local value = min + (max - min) * percent
                        UpdateSlider(value)
                    end
                end)
                
                SliderFrame.Parent = SectionContent
                return SliderFrame
            end
            
            function SectionFunctions:NewKeybind(name, defaultKey, callback)
                local function StringToKeyCode(str)
                    if typeof(str) ~= "string" then
                        return typeof(str) == "EnumItem" and str or Enum.KeyCode.Unknown
                    end
                    local alias = {
                        ["ALT"] = "LeftAlt",
                        ["CTRL"] = "LeftControl",
                        ["CONTROL"] = "LeftControl",
                        ["SHIFT"] = "LeftShift",
                        ["MOUSE1"] = "Mouse1",
                        ["MOUSE2"] = "Mouse2",
                    }
                    local upper = string.upper(str)
                    if alias[upper] then
                        str = alias[upper]
                    end
                    return Enum.KeyCode[str] or Enum.KeyCode.Unknown
                end
                
                local currentKey = StringToKeyCode(defaultKey)
                local listening = false
                
                local KeybindFrame = Instance.new("Frame")
                KeybindFrame.Name = name .. "_Keybind"
                KeybindFrame.BackgroundTransparency = 1
                KeybindFrame.Size = UDim2.new(1, 0, 0, 38)
                KeybindFrame.ZIndex = 6
                
                local KeybindLabel = Instance.new("TextLabel")
                KeybindLabel.Name = "Label"
                KeybindLabel.Parent = KeybindFrame
                KeybindLabel.BackgroundTransparency = 1
                KeybindLabel.Position = UDim2.new(0, 0, 0, 0)
                KeybindLabel.Size = UDim2.new(0.6, 0, 1, 0)
                KeybindLabel.Font = Enum.Font.Gotham
                KeybindLabel.Text = name
                KeybindLabel.TextColor3 = currentTheme.TextColor
                KeybindLabel.TextSize = 14
                KeybindLabel.TextXAlignment = Enum.TextXAlignment.Left
                KeybindLabel.ZIndex = 7
                
                local KeybindButton = Instance.new("TextButton")
                KeybindButton.Name = "KeybindButton"
                KeybindButton.Parent = KeybindFrame
                KeybindButton.BackgroundColor3 = currentTheme.ElementColor
                KeybindButton.BackgroundTransparency = OPACITY_ELEMENT
                KeybindButton.Position = UDim2.new(1, -110, 0, 3)
                KeybindButton.Size = UDim2.new(0, 100, 0, 32)
                KeybindButton.Font = Enum.Font.Gotham
                KeybindButton.Text = currentKey.Name ~= "Unknown" and currentKey.Name or "..."
                KeybindButton.TextColor3 = currentTheme.TextColor
                KeybindButton.TextSize = 14
                KeybindButton.AutoButtonColor = false
                KeybindButton.ZIndex = 7
                
                local ButtonCorner = Instance.new("UICorner")
                ButtonCorner.CornerRadius = UDim.new(0, 6)
                ButtonCorner.Parent = KeybindButton
                
                KeybindButton.MouseEnter:Connect(function()
                    if not listening then
                        Tween(KeybindButton, {
                            BackgroundColor3 = Color3.fromRGB(
                                math.clamp(currentTheme.ElementColor.R * 255 + 35, 0, 255),
                                math.clamp(currentTheme.ElementColor.G * 255 + 35, 0, 255),
                                math.clamp(currentTheme.ElementColor.B * 255 + 35, 0, 255)
                            ),
                            BackgroundTransparency = OPACITY_ELEMENT - 0.18
                        }, 0.14)
                    end
                end)
                
                KeybindButton.MouseLeave:Connect(function()
                    if not listening then
                        Tween(KeybindButton, {
                            BackgroundColor3 = currentTheme.ElementColor,
                            BackgroundTransparency = OPACITY_ELEMENT
                        }, 0.14)
                    end
                end)
                
                KeybindButton.MouseButton1Click:Connect(function()
                    listening = true
                    KeybindButton.Text = "..."
                    Tween(KeybindButton, {BackgroundColor3 = currentTheme.SchemeColor, BackgroundTransparency = 0.25}, 0.2)
                end)
                
                local inputConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
                    if listening and not gameProcessed then
                        local newKey
                        if input.UserInputType == Enum.UserInputType.Keyboard then
                            newKey = input.KeyCode
                        elseif input.UserInputType == Enum.UserInputType.MouseButton1 then
                            newKey = Enum.KeyCode.Mouse1
                        elseif input.UserInputType == Enum.UserInputType.MouseButton2 then
                            newKey = Enum.KeyCode.Mouse2
                        else
                            newKey = Enum.KeyCode.Unknown
                        end
                        currentKey = newKey
                        KeybindButton.Text = newKey.Name ~= "Unknown" and newKey.Name or "[None]"
                        Tween(KeybindButton, {BackgroundColor3 = currentTheme.ElementColor, BackgroundTransparency = OPACITY_ELEMENT}, 0.2)
                        listening = false
                        if callback then callback(currentKey) end
                    elseif not gameProcessed and input.KeyCode == currentKey then
                        if callback and not listening then callback(currentKey) end
                    end
                end)
                
                KeybindFrame.AncestryChanged:Connect(function(_, parent)
                    if not parent and inputConnection then
                        inputConnection:Disconnect()
                    end
                end)
                
                KeybindFrame.Parent = SectionContent
                
                local keybindObject = {}
                keybindObject.Frame = KeybindFrame
                
                function keybindObject:Set(newKey)
                    currentKey = StringToKeyCode(newKey)
                    KeybindButton.Text = currentKey.Name ~= "Unknown" and currentKey.Name or "[None]"
                    if callback then callback(currentKey) end
                end
                
                function keybindObject:Get()
                    return currentKey
                end
                
                return keybindObject
            end
            
            return SectionFunctions
        end
        
        return TabFunctions
    end
    
    return {
        AddTab = SimpleKavo.AddTab,
        ToggleUI = function()
            ScreenGui.Enabled = not ScreenGui.Enabled
        end,
        Destroy = function()
            ScreenGui:Destroy()
        end,
        ChangeTheme = function() end
    }
end

return SimpleKavo
